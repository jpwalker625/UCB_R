---
title: "Assignment_3"
author: "Joseph Walker"
date: "3/19/2017"
output: 
  html_document: 
    toc: yes
---

```{r setup, include = TRUE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
#load packages
library(tidyverse)
library(forcats)
library(lubridate)
library(rgdal)
library(leaflet)
library(sp)
library(htmltools)
```

###Problem 1
The U.S. Government Department of Labor, Bureau of Labor Statistics (BLS) publishes a Local Area
Unemployent Report, overview available here:

* https://www.bls.gov/lau/lauov.htm

Data format description here:

* https://www.bls.gov/help/hlpforma.htm#LA


Assignment:
Tidy the data set provided and generate four separate ggplot line plots (including points) of the following:

1. Employment
2. Labor Force
3. Unemploment Rate
4. Unemployment


###Tidy the Data
```{r sf_oak_metro data}

#read in data
df<- read_csv("sf_oak_metro.csv", col_names = T)

#tidy Data
sf_oak <- gather(df, Date, Value, -`Series ID`)

#uniform column names (lower case)
colnames(sf_oak) <- colnames(sf_oak) %>% tolower()

#rename the factors
sf_oak$`series id` <- sf_oak$`series id` %>% 
                      fct_recode(unemployment_rate = "LAUMT064186000000003",
                                 unemployment = "LAUMT064186000000004",
                                 employment = "LAUMT064186000000005",
                                 labor_force = "LAUMT064186000000006")


#parse date variable with lubridate functions
sf_oak$date <- parse_date_time2(sf_oak$date, '%b! %Y!')
sf_oak$month <- month(sf_oak$date,label = TRUE)
sf_oak$year <- as.factor(year(sf_oak$date))

glimpse(sf_oak)
```

###Plot the Data

```{r Plots}

sf_oak %>%
  filter(`series id` == 'employment') %>%
  ggplot(aes(month, value, group = year, colour = year)) +
  geom_point() +
  geom_line() +
  ggtitle(label = 'Monthly Employment Statistics for the San Francisco-Oakland-Hayward Metropolitan Area', 
          subtitle = '1990-2016') +
  theme(plot.title = element_text(size = 10, face = 'bold'),
        plot.subtitle = element_text(size = 10))


sf_oak %>%
  filter(`series id` == 'labor_force') %>%
  ggplot(aes(month, value, group = year, colour = year)) +
  geom_point() +
  geom_line() +
  ggtitle(label = 'Monthly Labor Force Statistics for the San Francisco-Oakland-Hayward Metropolitan Area', 
          subtitle = '1990-2016') +
  theme(plot.title = element_text(size = 10, face = 'bold'),
        plot.subtitle = element_text(size = 10))

sf_oak %>%
  filter(`series id` == 'unemployment') %>%
  ggplot(aes(month, value, group = year, colour = year)) +
  geom_point() +
  geom_line() +
  ggtitle(label = 'Monthly Unemployment Statistics for the San Francisco-Oakland-Hayward Metropolitan Area', 
          subtitle = '1990-2016') +
  theme(plot.title = element_text(size = 10, face = 'bold'),
        plot.subtitle = element_text(size = 10))

sf_oak %>%
  filter(`series id` == 'unemployment_rate') %>%
  ggplot(aes(month, value, group = year, colour = year)) +
  geom_point() +
  geom_line() +
  ggtitle(label = 'Monthly Unemployment Rate Statistics for the San Francisco-Oakland-Hayward Metropolitan Area',
  subtitle = '1990-2016') +
  theme(plot.title = element_text(size = 10, face = 'bold'),
  plot.subtitle = element_text(size = 10))

```

###Problem 2
The file assignment2_problem2_data_files.zip contains two files:
* A geospatial polygon file of USA counties: 'gz_2010_us_050_00_20m.json'
* a tsv file with monthy employment statistics for all California counties for 2016: california_counties_monthly_employment_2016.tsv


###2.1

Create a leaflet choropleth map showing the unemployment rates (only, with legend) for all California counties for December 2016 in your HTML report, generated from RMarkdown

```{r problem 2.1}
#Read in the geospatial polygot data using the function rgdal::readOGR()
usa.counties.mapping <- readOGR("gz_2010_us_050_00_20m.json")
class(usa.counties.mapping)

cal.counties.mapping <- usa.counties.mapping[usa.counties.mapping@data$STATE == '06', ]
glimpse(cal.counties.mapping@data)

employment.stats <- read_tsv("california_counties_monthly_employment_2016.tsv", col_names = T) 
glimpse(employment.stats)

employment.stats$period <- parse_date_time(employment.stats$period, "%Y-%m-%d")

#filter the data to contain only data for December
employment.stats <- employment.stats %>%
  filter(month(period) == 12)
employment.stats$fips_county<- factor(employment.stats$fips_county)

cal.merged <- merge(cal.counties.mapping, employment.stats, by.x = "COUNTY", by.y = "fips_county")


##we want to visaulize the unemployment rate data for month of december
#map the data
range(cal.merged$unemployed_rate)

bins <- c(0, 2.7, 6, 9, 12, 15, 18, Inf)

pal <- colorBin(palette = topo.colors(7), domain = cal.merged$unemployed_rate, bins = bins)

labels <- sprintf("<strong>%s</strong><br/>%g%%", cal.merged$NAME, cal.merged$unemployed_rate) %>%
  lapply(htmltools::HTML)


counties.map <- leaflet(cal.merged) %>%
  addProviderTiles(provider = providers$CartoDB) %>%
  addPolygons(fillColor = ~pal(cal.merged$unemployed_rate),
              weight = 2,
              opacity = 1,
              color = "white",
              dashArray = "3",
              fillOpacity = .7,
              highlight = highlightOptions(weight = 2,
                               fillColor = 'silver',
                               color = 'blue',
                               fillOpacity = 0.7,
                               bringToFront = TRUE),
              label = labels,
              labelOptions = labelOptions(style = list("font-weight" = "normal",
                                                       padding = "3px 8px"),
                                          textsize = "12px",
                                          direction = "auto")) %>%
  addLegend(position = 'topright', 
            pal = pal, 
            values = ~cal.merged$unemployed_rate,
            title = 'Unemployment Rate',
            opacity = 0.7)

counties.map
```


###2.2

A Shiny app that allows the user to choose the month (in a dropdown) for which to display the above choropleth map

```{r Problem 2.2}


```